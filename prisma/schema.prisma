generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ─── Enums ───────────────────────────────────────────────────────────────────

enum Role {
  ADMIN
  MEMBER
}

enum SystemRole {
  USER
  SUPER_ADMIN
}

enum ClubRole {
  ADMIN
  MEMBER
}

enum PollStatus {
  OPEN
  CLOSED
}

enum BourbonType {
  BOURBON
  RYE
  WHEAT
  SINGLE_MALT
  BLEND
  OTHER
}

enum Frequency {
  MONTHLY
  QUARTERLY
  ANNUAL
}

enum ExpenseCategory {
  BOURBON_PURCHASE
  VENUE
  SUPPLIES
  FOOD_DRINK
  OTHER
}

// ─── Auth Models (NextAuth v4 / @auth/prisma-adapter v1) ────────────────────

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ─── Core Models ─────────────────────────────────────────────────────────────

model User {
  id            String     @id @default(cuid())
  email         String     @unique
  emailVerified DateTime?
  name          String?
  phone         String?
  smsOptIn      Boolean    @default(false)
  role          Role       @default(MEMBER)
  systemRole    SystemRole @default(USER)
  currentClubId String?
  image         String?
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  accounts    Account[]
  sessions    Session[]
  votes       PollVote[]
  reviews     Review[]
  payments    Payment[]
  expenses    Expense[]
  memberships ClubMember[]
  currentClub Club?        @relation("CurrentClub", fields: [currentClubId], references: [id], onDelete: SetNull)
}

model Club {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  members     ClubMember[]
  invites     ClubInvite[]
  bourbons    Bourbon[]
  meetings    Meeting[]
  polls       Poll[]
  duesPeriods DuesPeriod[]
  expenses    Expense[]
  settings    AppSettings?
  currentUsers User[]   @relation("CurrentClub")
}

model ClubMember {
  id        String   @id @default(cuid())
  userId    String
  clubId    String
  role      ClubRole @default(MEMBER)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  club Club @relation(fields: [clubId], references: [id], onDelete: Cascade)

  @@unique([userId, clubId])
}

model ClubInvite {
  id        String   @id @default(cuid())
  clubId    String
  email     String
  role      ClubRole @default(MEMBER)
  createdAt DateTime @default(now())

  club Club @relation(fields: [clubId], references: [id], onDelete: Cascade)

  @@unique([clubId, email])
}

model Poll {
  id        String     @id @default(cuid())
  clubId    String?
  title     String
  status    PollStatus @default(OPEN)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  club    Club?        @relation(fields: [clubId], references: [id], onDelete: Cascade)
  options PollOption[]
  meeting Meeting?
}

model PollOption {
  id       String   @id @default(cuid())
  pollId   String
  date     DateTime
  selected Boolean  @default(false)

  poll  Poll       @relation(fields: [pollId], references: [id], onDelete: Cascade)
  votes PollVote[]
}

model PollVote {
  id           String @id @default(cuid())
  pollOptionId String
  userId       String

  pollOption PollOption @relation(fields: [pollOptionId], references: [id], onDelete: Cascade)
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([pollOptionId, userId])
}

model Meeting {
  id             String    @id @default(cuid())
  clubId         String?
  date           DateTime
  title          String
  description    String?
  location       String?
  reminderSentAt DateTime?
  pollId         String?   @unique
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  club     Club?            @relation(fields: [clubId], references: [id], onDelete: Cascade)
  poll     Poll?            @relation(fields: [pollId], references: [id], onDelete: SetNull)
  bourbons MeetingBourbon[]
}

model Bourbon {
  id            String      @id @default(cuid())
  clubId        String?
  name          String
  distillery    String?
  proof         Float?
  cost          Float?
  secondaryCost Float?
  type          BourbonType @default(BOURBON)
  region        String?
  age           Int?
  imageUrl      String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  club     Club?            @relation(fields: [clubId], references: [id], onDelete: Cascade)
  meetings MeetingBourbon[]
  reviews  Review[]
}

model MeetingBourbon {
  id        String @id @default(cuid())
  meetingId String
  bourbonId String

  meeting Meeting @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  bourbon Bourbon @relation(fields: [bourbonId], references: [id], onDelete: Cascade)
  reviews Review[]

  @@unique([meetingId, bourbonId])
}

model Review {
  id               String   @id @default(cuid())
  userId           String
  bourbonId        String
  meetingBourbonId String?
  rating           Float
  appearanceScore  Int?
  appearanceNotes  String?
  noseScore        Int?
  nose             String?
  tasteScore       Int?
  palate           String?
  mouthfeelScore   Int?
  mouthfeel        String?
  finishScore      Int?
  finish           String?
  notes            String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  bourbon        Bourbon         @relation(fields: [bourbonId], references: [id], onDelete: Cascade)
  meetingBourbon MeetingBourbon? @relation(fields: [meetingBourbonId], references: [id], onDelete: Cascade)

  @@unique([userId, meetingBourbonId])
}

model DuesPeriod {
  id        String    @id @default(cuid())
  clubId    String?
  name      String
  amount    Float
  dueDate   DateTime
  frequency Frequency
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  club     Club?     @relation(fields: [clubId], references: [id], onDelete: Cascade)
  payments Payment[]
}

model Payment {
  id           String    @id @default(cuid())
  userId       String
  duesPeriodId String
  paid         Boolean   @default(false)
  paidAt       DateTime?
  method       String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  duesPeriod DuesPeriod @relation(fields: [duesPeriodId], references: [id], onDelete: Cascade)

  @@unique([userId, duesPeriodId])
}

model Expense {
  id           String           @id @default(cuid())
  clubId       String?
  description  String
  amount       Float
  date         DateTime
  category     ExpenseCategory?
  notes        String?
  recordedById String
  recordedBy   User             @relation(fields: [recordedById], references: [id], onDelete: Cascade)
  club         Club?            @relation(fields: [clubId], references: [id], onDelete: Cascade)
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
}

model AppSettings {
  id                 String   @id @default(cuid())
  clubId             String?  @unique
  clubName           String   @default("Bourbon Club")
  venmoHandle        String?
  paypalEmail        String?
  reminderDaysBefore Int      @default(7)
  updatedAt          DateTime @updatedAt

  club Club? @relation(fields: [clubId], references: [id], onDelete: Cascade)
}
